<h1>ダッシュボード</h1>
<div style="display: flex; justify-content: space-between;">
    <div class="tab-buttons">
        {% for person in people %}
        <div class="tab-button" id="button-{{ person.id }}" onclick="window.showTab({{ person.id }})">
            {{ person.name }}
        </div>
        {% endfor %}
    </div>
    <!-- カレンダーを配置 -->
    <div id="calendar-container">
        <div id="calendar"></div>
    </div>
</div>
{% for person in people %}
<div class="tab" id="tab-{{ person.id }}">
    <h2>{{ person.name }}のタスク</h2>
    {% set sorted_tasks = person.sorted_tasks_title %}
    {% if sorted_tasks %}
    {% for task in sorted_tasks %}
    {% if selected_date %}
        {% set task_date = task.follow_up_date.date() if task.follow_up_date else None %}
        {% if task_date != selected_date %}
            {% continue %}
        {% endif %}
    {% endif %}
    {% set followup_class = task.follow_up_date|followup_style(today) %}
    <div class="task {{ followup_class }}" data-task-id="{{ task.id }}">
        <!-- ステータスボタンの表示 -->
        <button id="status-button-{{ task.id }}" onclick="window.cycleStatus({{ task.id }})" class="status-button {{ task.status }}">
            {% if task.status == 'not_started' %}未着手
            {% elif task.status == 'pending' %}保留中
            {% elif task.status == 'in_progress' %}進行中
            {% elif task.status == 'completed' %}完了
            {% else %}不明{% endif %}
        </button>

        <!-- タイトルをリンクに変更 -->
        <a href="#" class="task-title-link" onclick="window.loadContent('/person_tasks/{{ task.person_id }}', 'task-{{ task.id }}')">
            {{ task.title }}
        </a>

        <!-- フォロー日 -->
        <span class="follow-up-date" data-task-id="{{ task.id }}" onclick="window.editFollowUpDate({{ task.id }})">
            フォロー日: <span id="follow-up-date-display-{{ task.id }}">{{ task.follow_up_date|format_date }}</span>
        </span>
    </div>
    {% endfor %}
    {% else %}
    <p>タスクがありません。</p>
    {% endif %}
</div>
{% endfor %}

<!-- 必要なスタイルを追加 -->
<style>
    /* タブのスタイル */
    .tab {
        display: none;
    }
    .tab.active {
        display: block;
    }
    .tab-buttons {
        display: flex;
        margin-bottom: 10px;
    }
    .tab-button {
        padding: 10px;
        cursor: pointer;
        border: 1px solid #ccc;
        margin-right: 5px;
    }
    .tab-button.active {
        font-weight: bold;
        background-color: #eee;
    }
    /* タスクのスタイル */
    .task {
        padding: 10px;
        border-bottom: 1px solid #ccc;
        display: flex;
        align-items: center;
    }
    /* フォロー日の背景色と文字色 */
    .task.today {
        background-color: #FFCDD2; /* 薄い赤色 */
        color: black;
    }
    .task.overdue {
        background-color: #FFC0CB; /* ピンク色 */
        color: black;
    }
    /* ステータスボタンのスタイル */
    .status-button {
        width: 100px; /* 幅を固定して左端を揃える */
        padding: 5px 10px;
        border-radius: 3px;
        color: #fff;
        border: none;
        cursor: pointer;
        margin-right: 10px;
        flex-shrink: 0;
    }
    .status-button.pending {
        background-color: orange;
    }
    .status-button.in_progress {
        background-color: blue;
    }
    .status-button.completed {
        background-color: green;
    }
    .task-title-link {
        margin-right: 10px;
        flex-grow: 1;
        text-decoration: none;
        color: white; /* 白い文字 */
    }
    .task-title-link:hover {
        text-decoration: underline;
    }
    .follow-up-date {
        margin-right: 10px;
        flex-shrink: 0;
        cursor: pointer;
    }
    /* 背景がピンク色の場合にリンクの文字色を黒に変更 */
    .task.today .task-title-link,
    .task.overdue .task-title-link {
        color: black; /* 黒い文字 */
    }
    /* カレンダーのスタイル */
    #calendar-container {
        width: 300px;
    }
</style>

<!-- フルカレンダーのスクリプトとスタイルを追加 -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>

<!-- JavaScriptを追加 -->
<script>
    window.editFollowUpDate = function(taskId) {
        var dateSpan = document.getElementById('follow-up-date-display-' + taskId);
        var currentDate = dateSpan.textContent.trim();
        var newInput = document.createElement('input');
        newInput.type = 'date';
        // 現在の日付を取得してセット
        var dateValue = '';
        if (currentDate !== '未設定') {
            // 'YYYY年MM月DD日' を 'YYYY-MM-DD' に変換
            var match = currentDate.match(/(\d{4})年(\d{2})月(\d{2})日/);
            if (match) {
                dateValue = match[1] + '-' + match[2] + '-' + match[3];
            }
        }
        newInput.value = dateValue;
        dateSpan.parentNode.replaceChild(newInput, dateSpan);

        newInput.focus();

        newInput.addEventListener('blur', function() {
            var newDate = newInput.value;
            var formData = new FormData();
            formData.append('new_date', newDate);
            fetch('/update_follow_up_date/' + taskId, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                // 新しい日付を表示
                var newDateText = data.new_date || '未設定';
                var newSpan = document.createElement('span');
                newSpan.id = 'follow-up-date-display-' + taskId;
                newSpan.textContent = newDateText;
                newInput.parentNode.replaceChild(newSpan, newInput);

                // タスクの背景色を更新
                var taskDiv = document.querySelector('.task[data-task-id="' + taskId + '"]');
                if (taskDiv) {
                    taskDiv.classList.remove('today', 'overdue');
                    if (data.followup_class) {
                        taskDiv.classList.add(data.followup_class);
                    }
                }

                // カレンダーを再描画
                window.calendar.refetchEvents();
            });
        });
    };

    document.addEventListener('DOMContentLoaded', function() {
        // カレンダーの初期化
        var calendarEl = document.getElementById('calendar');
        window.calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ja',
            events: '/get_calendar_events',
            eventDisplay: 'background',
            selectable: true,
            select: function(info) {
                var selectedDate = info.startStr;
                var urlParams = new URLSearchParams(window.location.search);
                urlParams.set('follow_up_date', selectedDate);
                window.location.search = urlParams.toString();
            }
        });
        window.calendar.render();
    });
</script>
