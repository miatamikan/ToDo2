<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>{{ person.name }}のタスク一覧</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <script src="{{ url_for('static', filename='sortable.min.js') }}"></script>
</head>
<body>
<div class="container mt-5">
    <h1>{{ person.name }}のタスク</h1>
    <a href="/" class="btn btn-secondary">トップページに戻る</a>

    <ul id="task-list" class="list-group mt-3">
        {% for task in tasks %}
        <li class="list-group-item task-item" data-task-id="{{ task.id }}">
            <div class="task-content" style="max-height: 400px; overflow: hidden;">
                {{ task.content | safe }}
            </div>
            {% if task.person %}
            <br><strong>担当者:</strong> {{ task.person.name }}
            {% else %}
            <br><strong>担当者:</strong> 未割り当て
            {% endif %}
            <br><strong>最終更新日:</strong> {{ task.last_updated | format_datetime_jst }}

            <a href="/edit/{{ task.id }}" class="btn btn-sm btn-info float-right">編集</a>
            <a href="/delete/{{ task.id }}" class="btn btn-sm btn-danger float-right mr-2" onclick="return confirm('本当に削除しますか？');">削除</a>
        </li>
        {% endfor %}
    </ul>
</div>

<script>
    let page = 1;
    const perPage = 20;
    let isLoading = false;

    function loadMoreTasks() {
        if (isLoading) return;
        isLoading = true;
        page++;

        $.get(`/load_tasks?page=${page}&per_page=${perPage}`, function(data) {
            if (data.tasks.length > 0) {
                data.tasks.forEach(function(task) {
                    $('#task-list').append(`
                        <li class="list-group-item">
                            <div class="task-content" style="max-height: 400px; overflow: hidden;">
                                ${task.content}
                            </div>
                            <br><strong>担当者:</strong> ${task.person_name}
                            <br><strong>最終更新日:</strong> ${task.last_updated}
                        </li>
                    `);
                });
                isLoading = false;
                if (!data.has_next) {
                    $(window).off('scroll');
                }
            }
        });
    }

    $(window).scroll(function() {
        if ($(window).scrollTop() + $(window).height() > $(document).height() - 100) {
            loadMoreTasks();
        }
    });

    $(document).ready(function() {
        loadMoreTasks();
    });
</script>

</body>
</html>
